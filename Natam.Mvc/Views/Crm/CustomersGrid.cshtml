@model Pro.Models.CustomerQuery
@{
    Layout = "~/Views/Shared/_View.cshtml";
    ViewBag.Title = "Buildings";
    
  
}
@section head { 

    @Scripts.Render("~/bundles/jqx")
    @Scripts.Render("~/bundles/jqxgrid")
    <script type="text/javascript" src="~/jqwidgets/jqxdata.export.js"></script>
@*<link rel="stylesheet" href="~/Scripts/app/app-form.css" type="text/css" />*@
    <style type="text/css">
        input {
            direction:rtl;text-align:right;
        }
          .jqx-grid-cell {
            border: none;
        }
    </style>
}


@section scripts {

    <script type="text/javascript">

        var NScustomers = {};
        $(document).ready(function () {
            JSON.useDateParser();
            var theme = 'Arctic';

            var allowEdit = ('@ViewBag.UserRole' == 9) ? 1 : 0;

            // prepare the data
            var source =
            {
                datatype: "json",
                datafields: [
                    { name: 'AccountId', type: 'number' },
                    { name: 'AccountName', type: 'string' },
                    { name: 'AccountType', type: 'number' },
                    { name: 'Address', type: 'string' },
                    { name: 'City', type: 'string' },
                    { name: 'ZipCode', type: 'number' },
                    //{ name: 'ContactName', type: 'string' },
                    { name: 'Phone1', type: 'string' },
                    { name: 'Phone2', type: 'string' },
                    { name: 'Phone3', type: 'string' },
                    { name: 'Creation', type: 'date' },
                    //{ name: 'Email', type: 'string' },
                    { name: 'Fax', type: 'string' },
                    { name: 'WebSite', type: 'string' },
                    { name: 'Details', type: 'string' }
                    
                ],
                id: 'AccountId',
                type:'POST',
                url: '@Url.Action("GetCustomersGrid", "Crm")',
               
                pagenum: 3,
                pagesize: 20,
                pager: function (pagenum, pagesize, oldpagenum) {
                    // callback called when a page or page size is changed.
                }
            };

            source.data = { 'QueryType': '@Model.QueryType', 'NewsType': '@Model.NewsType', 'CustomerName': '@Model.CustomerName', 'ContactName': '@Model.ContactName', 'AccType': '@Model.AccType' };


            //var dataAdapter = new $.jqx.dataAdapter(source);
            var dataAdapter = new $.jqx.dataAdapter(source, {
                async: false,
                loadComplete: function (data) { },
                loadError: function (xhr, status, error) { alert(' status: ' + status + '\n error ' + error) }
            });
            
            var contactcellsrenderer = function (row, columnfield, value, defaulthtml, columnproperties) {
                var accid = $('#jqxgrid').jqxGrid('getrowdata', row).AccountId;
               
                return '<div style="text-align:center;direction:rtl;margin:5px;"><a href="#" onclick="app_contacts.contactEdit(' + value + ',' + accid + ',0);" >הצג</a> | <a href="#" onclick="app_contacts.contactDelete(' + value + ');">הסר</a></div>'
            };

            NScustomers.nastedContactGrids = new Array();

            var initContactGrid = function (tabControl, index, id) {
                //contacts
                var nastedcontainer = $('<div style="float:right;margin:5px"></div>');
                nastedcontainer.rtl = true;
                var nastedsource = {
                    datafields: [
                          { name: 'ContactId', type: 'number' },
                          { name: 'ParentId', type: 'number' },
                          { name: 'ContactName', type: 'string' },
                          { name: 'Title', type: 'string' },
                          { name: 'Email', type: 'string' },
                          { name: 'Mobile', type: 'string' }
                    ],
                    datatype: "json",
                    id: 'ContactId',
                    type: 'POST',
                    url: '@Url.Action("GetContactsView", "Crm")',
                    data: { 'parentId': id, 'role': 0, 'uk': null }
                }
                NScustomers.nastedContactGrids[index] = nastedcontainer;

                var nastedAdapter = new $.jqx.dataAdapter(nastedsource);
                nastedcontainer.jqxGrid({
                    source: nastedAdapter, width: '98%', height: 130,
                    rtl: true,
                    columns: [
                      {
                          text: '*', dataField: 'ContactId', width: 35, cellsalign: 'right', align: 'center',
                          cellsrenderer: function (row, columnfield, value, defaulthtml, columnproperties) {
                              var accid = id;// $('#jqxgrid').jqxGrid('getrowdata', row).AccountId;
                              return '<div style="margin:4px 4px;direction:rtl"><a title="עריכת איש קשר" href="javascript:app_accounts_public.customers_contactEdit(' + value + ',' + accid + ')" ><i class="fa fa-plus-square-o" style="font-size:14px;color:#000;"></i></a><span style="padding-left:5px"></span><a href="#" title="מחיקת איש קשר" onclick="app_accounts_public.customers_contactDelete(' + value + ');"><i class="fa fa-remove" style="font-size:14px;color:red;"></i></a></div>';

                              //return '<div style="text-align:center;direction:rtl;margin:5px;"><a href="#" onclick="app_accounts_public.customers_contactEdit(' + value + ',' + accid + ');" >הצג</a> | <a href="#" onclick="app_accounts_public.customers_contactDelete(' + value + ');">הסר</a></div>'
                          }
                      },
                      { text: 'שם איש קשר', datafield: 'ContactName', cellsalign: 'right', align: 'center' },
                      { text: 'תפקיד', datafield: 'Title', width: 150, cellsalign: 'right', align: 'center' },
                      { text: 'דואל', datafield: 'Email', width: 150, align: 'center' },
                      { text: 'טלפון נייד', datafield: 'Mobile', width: 200, align: 'center' }
                    ]
                });
                //var additem = $('<div style="margin:10px"><input type="button" value="הוסף" title="הוספת איש קשר חדש" /></div>')
                //.click(function () {
                //    NScustomers.contactDialog=contactEdit(0, id,0);
                //});
                //var refreshcontacts = $('<div style="margin:10px"><input type="button" value="רענן" title="רענון רשימת אנשי קשר" /></div>')
                //.click(function () {
                //    nastedAdapter.dataBind();
                //});

                var additem = $('<a title="הוספת איש קשר חדש" href="#" style="padding-left:10px;padding-right:10px;float:right;">הוסף איש קשר</a>')
                .click(function () {
                    NScustomers.contactDialog = app_contacts.contactEdit(0, id, 0);
                });
                var refreshcontacts = $('<a title="רענון רשימת אנשי קשר" href="#" style="padding-left:10px;float:right;">רענון</a>')
                .click(function () {
                    nastedAdapter.dataBind();
                });

                $(tabControl).append(additem);
                $(tabControl).append(refreshcontacts);
                $(tabControl).append(nastedcontainer);

            };

            NScustomers.nastedNewsGrids = new Array();
            var initNewsGrid = function (tabControl, index, id) {

                var nastedcontainer = $('<div style="float:right;margin:5px"></div>');
                nastedcontainer.rtl = true;
                var nastedsource = {
                    datafields: [
                          { name: 'NewsId', type: 'number' },
                          { name: 'NewsName', type: 'string' },
                    ],
                    datatype: "json",
                    id: 'NewsId',
                    type: 'POST',
                    url: '@Url.Action("GetAcoountNews", "Crm")',
                    data: { 'accountId': id }
                }
                NScustomers.nastedNewsGrids[index] = nastedcontainer;

                var nastedAdapter = new $.jqx.dataAdapter(nastedsource);
                nastedcontainer.jqxGrid({
                    source: nastedAdapter, width: '98%', height: 130,
                    rtl: true,
                    columns: [
                      {
                          text: '*', dataField: 'NewsId', width: 110, cellsalign: 'right', align: 'center',
                          cellsrenderer: function (row, columnfield, value, defaulthtml, columnproperties) {
                              var accid = id;//  $('#jqxgrid').jqxGrid('getrowdata', row).AccountId;
                              return '<div style="text-align:center;direction:rtl;margin:5px;"><a href="#" onclick="app_accounts_public.customers_newsDelete(' + value + ',' + accid + ');" >הסר</a></div>'
                          }
                      },
                      { text: 'שם דיוור', datafield: 'NewsName', cellsalign: 'right', align: 'center' },
                    ]
                });
                var additem = $('<a title="הוספת דיוור" href="#" style="padding-left:10px;padding-right:10px;float:right;">הוסף דיוור</a>')
                .click(function () {
                    NScustomers.newsDialog = app_dialog.dialogIframe("/Common/_AccountNews?id=" + id, "580", "400");
                });
                var refreshitem = $('<a title="רענון קבוצת דיוור" href="#" style="padding-left:10px;float:right;">רענון</a>')
                .click(function () {
                    nastedAdapter.dataBind();
                });

                $(tabControl).append(additem);
                $(tabControl).append(refreshitem);
                $(tabControl).append(nastedcontainer);

            };

            var initrowdetails = function (index, parentElement, gridElement, datarecord) {

                NScustomers.currentIndex = index;

                var tabsdiv = null;
                var information = null;
                var notes = null;

                tabsdiv = $($(parentElement).children()[0]);
                if (tabsdiv != null) {
                    information = tabsdiv.find('.information');
                    notes = tabsdiv.find('.notes');
                    var title = tabsdiv.find('.title');
                    title.text(datarecord.AccountName);
                    var tabcontacts = tabsdiv.find('.tabcontacts');
                    var tabnews = tabsdiv.find('.tabnews');
                    var taboptions = tabsdiv.find('.taboptions');

                    var container = $('<div style="margin: 5px;text-align:right;"></div>')
                    container.rtl = true;
                    container.appendTo($(information));

                    var leftcolumn = $('<div style="float: left; width: 45%;direction:rtl;"></div>');
                    var rightcolumn = $('<div style="float: right; width: 40%;direction:rtl;"></div>');
                    container.append(leftcolumn);
                    container.append(rightcolumn);

                    var divLeft = $("<div style='margin: 10px;'><b>טלפון 1:</b> " + datarecord.Phone1 + "</div>" +
                        "<div style='margin: 10px;'><b>טלפון 2:</b> " + datarecord.Phone2 + "</div>" +
                        "<div style='margin: 10px;'><b>קוד לקוח:</b> " + datarecord.AccountId + "</div>");
                    divLeft.rtl = true;
                    var divRight = $(
                        //"<div style='margin: 10px;'><b>מייל:</b> " + datarecord.Email + "</div>" +
                        "<div style='margin: 10px;'><b>פקס:</b> " + datarecord.Fax + "</div>" +
                        "<div style='margin: 10px;'><b>אתר:</b> " + datarecord.WebSite + "</div>");

                    divRight.rtl = true;
                    $(leftcolumn).append(divLeft);
                    $(rightcolumn).append(divRight);

                    var notescontainer = $('<div style="white-space: normal; margin: 5px;text-align:right;"><span>' + datarecord.Details + '</span></div>');
                    notescontainer.rtl = true;
                    $(notes).append(notescontainer);

                    var accid = datarecord.AccountId;//parseInt(datarecord.AccountId);

                    var optionscontainer = $('<div style="white-space: normal; margin: 5px;text-align:right;"></div>');
                    optionscontainer.rtl = true;

                    var linkEdit = $('<div style="margin:5px"><a href="#" >הצג לקוח</a></div>')
                    .click(function () {
                        app_accounts_public.customers_accountEdit(accid);
                    });
                    var linkRemove = $('<div style="margin:5px"><a href="#" >הסר לקוח</a></div>')
                    .click(function () {
                        app_accounts_public.customers_accountDelete(accid);
                    });

                    optionscontainer.append(linkEdit);
                    if (allowEdit > 0)
                        optionscontainer.append(linkRemove);
                    taboptions.append(optionscontainer);
                    
                    //contacts
                    initContactGrid(tabcontacts, index, accid);
                    
                    
                        //news
                        initNewsGrid(tabnews, index, accid);
                    
                    $(tabsdiv).jqxTabs({ width: '95%', height: 170, rtl: true });
                }
            };

            // create Tree Grid
            $("#jqxgrid").jqxGrid(
            {
                width: '100%',
                autoheight: true,
                rtl: true,
                source: dataAdapter,
                localization: getLocalization('he'),
                pagermode: 'simple',
                pageable: true,
                sortable: true,
                showfilterrow: true,
                filterable: true,
                rowdetails: true,
                rowdetailstemplate: { rowdetails: "<div style='margin: 10px;'><ul style='margin-right: 30px;'><li class='title'></li><li>פרטים</li><li>אנשי קשר</li><li>קבוצת דיוור</li><li>אפשרויות</li></ul><div class='information'></div><div class='notes'></div><div class='tabcontacts'></div><div class='tabnews'></div><div class='taboptions'></div></div>", rowdetailsheight: 200 },
                ready: function () {
                    $("#jqxgrid").jqxGrid('showrowdetails', 0);
                },
                initrowdetails: initrowdetails,
                columns: [
                  { text: '*', dataField: 'AccountId', filterable: false, width: 30, cellsalign: 'right', align: 'center', cellsrenderer: 
                      function (row, columnfield, value, defaulthtml, columnproperties) {
                          return '<a href="javascript:app_accounts_public.customers_accountEdit(' + value + ')" ><i class="fa fa-plus-square-o" style="font-size:14px;color:#000;margin:8px 8px"></i></a>';
                      }
                   },
                  { text: 'שם לקוח', dataField: 'AccountName', filtercondition: 'CONTAINS', cellsalign: 'right', align: 'center' },
                  //{ text: 'סוג לקוח', dataField: 'AccountType', width: 100, cellsalign: 'right', align: 'center' },
                  { text: 'עיר', dataField: 'City', filtercondition: 'starts_with', cellsalign: 'right', align: 'center' },
                  { text: 'כתובת', dataField: 'Address', filtercondition: 'starts_with', cellsalign: 'right', align: 'center' },
                  //{ text: 'איש קשר', dataField: 'ContactName', filtercondition: 'starts_with', width: 120, cellsalign: 'right', align: 'center' },
                  { text: 'טלפון', dataField: 'Phone1', filtercondition: 'starts_with', width: 150, cellsalign: 'right', align: 'center' },
                  { text: 'מועד עדכון', type: 'date', dataField: 'Creation', width: 120, cellsformat: 'd', cellsalign: 'right', align: 'center' }
                ]
            });

            //$("#linkCustomerDef").jqxLinkButton({ width: '120', height: '30' });
            $('#btnclearfilter').jqxButton();
            $('#btnclearfilter').click(function () {
                $("#jqxgrid").jqxGrid('clearfilters');
            });
            $('#btnCustomerDef').jqxButton();
            $('#btnCustomerDef').click(function () {
                app_accounts_public.customers_accountEdit(0);
            });
            $('#btnCustomerQuery').jqxButton();
            $('#btnCustomerQuery').click(function () {
                app.redirectTo("CustomerQuery");
            });
            $('#btnCustomerAll').jqxButton();
            $('#btnCustomerAll').click(function () {
                app.redirectTo('@Url.Action("CustomersGrid", "Crm")');
            });
            //$("#excelExport").jqxButton({ width: '120', height: '30' });
            //$("#excelExport").click(function () {
            //    $("#jqxgrid").jqxGrid('exportdata', 'xls', 'Customers',true, null, false,null,'utf-8');   

            //});
        });

    </script>
}


@section featured {


}

<div class="breadcrumbs">
@Html.ActionLink("Home", "Index", "Home")>
@Html.ActionLink("Main", "Main", "Home")>
<a href="javascript:parent.history.back()">Crm</a> >
@ViewContext.RouteData.Values["action"].ToString()
</div>


@*<hgroup class="title">
    <h3 class="rightPan">רשימת לקוחות</h3>
</hgroup>*@

<div class="clear"></div>

<div class="global">
    <div class="container-box">

        <div class="grid-wrap">
            <div class="box-title">
                <h3>רשימת לקוחות</h3>
            </div>
            <div id="wiz-parent" class="rtl">
                <div style="display: inline; float: right">
                    <!--<a id="linkCustomerDef" href="~/Crm/CustomerDef?id=0" title="הוספת לקוח">הוספת לקוח חדש</a>
                <a id="linkCustomerDef" href="javascript:app_accounts.accountEdit(0 ,1)" title="הוספת לקוח">הוספת לקוח חדש</a>-->

                    <input value="איתור לקוח" id="btnCustomerQuery" type="button" class="btn-default btn2" />
                    <input value="הוספת לקוח" id="btnCustomerDef" type="button" class="btn-default btn2" />
                    <input value="הסר סינון" id="btnclearfilter" type="button" class="btn-default btn2" />
                    <input value="הצגת כל הלקוחות" id="btnCustomerAll" type="button" class="btn-default btn2" />
                </div>

                <div id="jqxWidget">
                    <div id="jqxgrid" style="position:relative;z-index:1;"></div>
                    <div style="margin-top: 30px;">
                        <div id="cellbegineditevent"></div>
                        <div style="margin-top: 10px;" id="cellendeditevent"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<script type="text/javascript">
    app_menu.activeLayoutMenu("liCustomers");

    var app_accounts_public = {

        customers_contactRefresh: function () {
            try {
                var i = NScustomers.currentIndex;
                var g = NScustomers.nastedContactGrids[i];
                var adapter = g.jqxGrid('source');
                adapter.dataBind();
            }
            catch (e) {
                alert(e);
            }
        },

        customers_contactDelete: function (id) {
            app_contacts.contactDelete(id, false);
            app_accounts_public.customers_contactRefresh();
        },

        customers_contactEdit: function (id, accid) {
            app_contacts.contactEdit(id, accid, 0);
            app_accounts_public.customers_contactRefresh();
        },

        customers_newsRefresh: function () {
            try {
                var i = NScustomers.currentIndex;
                var g = NScustomers.nastedNewsGrids[i];
                var adapter = g.jqxGrid('source');
                adapter.dataBind();
            }
            catch (e) {
                alert(e);
            }
        },
        customers_newsDelete: function (id, accid) {
            app_accounts.AccountNewsRemove(id, accid);
            app_accounts_public.customers_newsRefresh();
        },

        customers_accounsRefresh: function () {
            try {
                $("#jqxgrid").jqxGrid('source').dataBind();
            }
            catch (e) {
                alert(e);
            }
        },
        customers_accountEdit: function (id) {
            var accountType = 1;// 'Model.AccType';
            //NScustomers.accountDialog = app_accounts.accountEdit(id, accountType);
            app_accounts.accountPanelSwitch(id, accountType, "wiz-parent");

        },
        customers_accountDelete: function (id) {

            if (confirm("פעולה זו תסיר את הלקוח מרשימת הלקוחות , האם להמשיך?") == false)
                return;
            $.ajax({
                url: '@Url.Action("CustomerDelete", "Crm")',
                type: 'post',
                dataType: 'json',
                data: { 'AccountId': id },
                success: function (data) {
                    if (data.Status >= 0) {
                        app_jqxnotify.notify("הלקוח הוסר מהמערכת");

                        app_accounts_public.customers_accounsRefresh();
                        //redirectToFinal("customer-del");
                    }
                    else
                        alert(data.Message);
                },
                error: function (jqXHR, status, error) {
                    alert(error);
                }
            });
        }
    };

    app_trigger = {

        triggerContactComplete: function (accid) {
            app_accounts_public.customers_contactRefresh();
            app_dialog.dialogClose(slf.NScustomers.contactDialog);
        },
         triggerNewsComplete: function (accid) {
            app_accounts_public.customers_newsRefresh();
            app_dialog.dialogClose(slf.NScustomers.newsDialog);
         },
         triggerAccComplete: function (accType, accid) {
             app_accounts_public.customers_accounsRefresh();
             app_iframe.panelSwitchClose("wiz-parent", true);
             //app_dialog.dialogClose(slf.NScustomers.accountDialog);
             return false;
         },

        triggerAccCancel: function () {
            app_iframe.panelSwitchClose("wiz-parent", true);
        }
    };
</script>

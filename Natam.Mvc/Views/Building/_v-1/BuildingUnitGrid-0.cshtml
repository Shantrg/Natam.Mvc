@model Pro.Models.BuildingQuery
@{
    Layout = "~/Views/Shared/_View.cshtml";
    ViewBag.Title = "Buildings";
}

@section head { 
    @Scripts.Render("~/bundles/jqx")
    @Scripts.Render("~/bundles/jqxgrid")
    @*<script src="~/Scripts/app/model/units-grid.js"></script>*@
    <style type="text/css">

        .row_detail {margin: 10px;direction:rtl;}
        .row_link {margin: 10px;direction:rtl;font-size:16px}

    </style>
}


@section scripts {

    <script type="text/javascript">
    var allowEdit = 0;
    $(document).ready(function () {

        allowEdit = ('@ViewBag.UserRole' == 9) ? 1 : 0;
        var userId = '@ViewBag.UserId';

        // First, checks if it isn't implemented yet.
        if (!String.prototype.format) {
            String.prototype.format = function () {
                var args = arguments;
                return this.replace(/{(\d+)}/g, function (match, number) {
                    return typeof args[number] != 'undefined'
                      ? args[number]
                      : match
                    ;
                });
            };
        }

        JSON.useDateParser();
        var theme = 'Arctic';

        @*app_jqx_units_grid.load('@Model.QueryType', '@Model.Area', '@Model.DealType', '@Model.PurposeType', '@Model.AreaSizeMin', '@Model.AreaSizeMax', '@Model.BuildingName', '@Model.BuildingStreet', '@Model.StreetNo', '@Model.City', '@Model.OwnerId','@Model.BuildingId');*@

        // prepare the data
        var source =
        {
            //sort: customsortfunc,
            datatype: "json",
            datafields: [
                { name: 'UnitId', type: 'number' },
                { name: 'BuildingId', type: 'number' },
                { name: 'BuildingName', type: 'string' },
                { name: 'FloorNum', type: 'number' },
                { name: 'UnitNum', type: 'number' },
                { name: 'UnitSize', type: 'number' },
                { name: 'Price', type: 'number' },
                { name: 'Populate', type: 'bool' },
                { name: 'UserName', type: 'string' },
                { name: 'OwnerId', type: 'number' },
                { name: 'OwnerName', type: 'string' },
                { name: 'Memo', type: 'string' },
                { name: 'LastUpdate', type: 'date' },
                { name: 'PurposeId', type: 'number' },
                { name: 'PurposeName', type: 'string' },
                { name: 'DealType', type: 'string' },
                { name: 'DealName', type: 'string' },
                { name: 'PropertyType', type: 'number' }
            ],
            id: 'UnitId',
            type: 'POST',
            url: '@Url.Action("GetBuildingUnitGrid", "Building")',
            //pagenum: 3,
            pagesize: 20,
            root: 'Rows',
            beforeprocessing: function (data) {
                source.totalrecords = data.TotalRows;
            },
            pager: function (pagenum, pagesize, oldpagenum) {
                // callback called when a page or page size is changed.
            }
        };

        source.data = { 'QueryType': '@Model.QueryType', 'Area': '@Model.Area', 'DealType': '@Model.DealType', 'PurposeType': '@Model.PurposeType', 'AreaSizeMin': '@Model.AreaSizeMin', 'AreaSizeMax': '@Model.AreaSizeMax', 'BuildingName': '@Model.BuildingName', 'BuildingStreet': '@Model.BuildingStreet', 'StreetNo': '@Model.StreetNo', 'City': '@Model.City', 'OwnerId': '@Model.OwnerId', 'BuildingId': '@Model.BuildingId' };


        var dataAdapter = new $.jqx.dataAdapter(source, {
            loadComplete: function (data) { }
            //loadError: function (xhr, status, error) { alert('error ' + error) }
        });

      
        var initrowdetails = function (index, parentElement, gridElement, datarecord) {
            var tabsdiv = null;
            var information = null;
            var notes = null;
            var actions = null;
            tabsdiv = $($(parentElement).children()[0]);
            if (tabsdiv != null) {
                information = tabsdiv.find('.information');
                notes = tabsdiv.find('.notes');
                actions = tabsdiv.find('.actions');

                var title = tabsdiv.find('.title');
                title.text(datarecord.BuildingName);

                //info container
                var container = $('<div style="margin: 5px;text-align:right;"></div>')
                container.rtl = true;
                container.appendTo($(information));
                var leftcolumn = $('<div style="float: left; width: 45%;direction:rtl;"></div>');
                var rightcolumn = $('<div style="float: right; width: 40%;direction:rtl;"></div>');
                //var photocolumn = $('<div style="float: left; width: 15%;"></div>');

                //container.append(photocolumn);
                container.append(leftcolumn);
                container.append(rightcolumn);

                //var mediaLink = $('<a class="row_link" href="#popupMedia" data-rel="popup" data-position-to="window" data-role="button" data-theme="a" data-inline="true">תמונות</a>')
                // var mediaLink = $('<input type="button" value="תמונות"/>')
                //.on("click", function (e) {
                //    e.preventDefault();
                //    //dialogIframe("_Media?bid=" + datarecord.BuildingId + "&pid=" + datarecord.UnitId + "&pt=u", "900", "520", "מדיה");
                //    mediaEditor(datarecord.BuildingId, datarecord.UnitId, "u");
                //});
                //$(photocolumn).append(mediaLink);

                var infosection = "<div class='row_detail'><b>{0}:</b>{1}</div>";

                $(leftcolumn).append(infosection.format("מספר קומה", datarecord.FloorNum));
                $(leftcolumn).append(infosection.format("מספר יחידה", datarecord.UnitNum));
                $(leftcolumn).append(infosection.format("שטח", datarecord.UnitSize));
                $(leftcolumn).append(infosection.format("מחיר", datarecord.Price));

                //$(rightcolumn).append(infosection.format("איש קשר", datarecord.ContactName));
                //$(rightcolumn).append(infosection.format("טלפון", datarecord.ContactPhone));
                //$(rightcolumn).append(infosection.format("סלולארי", datarecord.ContactMobile));
                //$(rightcolumn).append(infosection.format("דואל", datarecord.ContactMail));
                $(rightcolumn).append(infosection.format("קוד יחידה", datarecord.UnitId));
                $(rightcolumn).append(infosection.format("קוד בניין", datarecord.BuildingId));

                var ownerContainer = $("<div style='margin: 10px;direction:rtl;'><b>בעלים:</b> <a href='#' data-rel='popup' data-position-to='window' data-role='button' data-theme='a' data-inline='true'>" + datarecord.OwnerName + "</a></div>")
                  .on("click", function (e) {
                      e.preventDefault();
                      //popupIframe("_AccountInfo?id=" + datarecord.OwnerId, "240", "120");
                      accountDisplay(datarecord.OwnerId, "בעלים");
                  });

                $(rightcolumn).append(ownerContainer);

                //notes container
                var notescontainer = $('<div style="white-space: normal; margin: 5px;text-align:right;"><span>' + datarecord.Memo + '</span></div><br/>' +
                    '<div style="white-space: normal; margin: 5px;text-align:right;"><span>' + '' + '</span></div>');
                notescontainer.rtl = true;
                $(notes).append(notescontainer);


                //actions container
                var actionscontainer = $('<div style="white-space: normal; margin: 5px;text-align:right;"></div>');
                actionscontainer.rtl = true;
                //actionscontainer.append("<span class='row_link'><a href='../Crm/Advertise?id=" + datarecord.UnitId + "&op=property'>פרסום חדש</a></span>");
                //actionscontainer.append("<span class='row_link'><a href='../Crm/AdsGrid?id=" + datarecord.UnitId + "&op=property'>דוח פרסום</a></span>");

                var propType = datarecord.PropertyType;
                if (propType == 1 && (userId == datarecord.AgentId || allowEdit == 1)) {
                    actionscontainer.append("<span class='row_link'><a href='javascript:deleteUnit(" + datarecord.UnitId + "," + datarecord.BuildingId + "," + datarecord.FloorNum + "," + datarecord.PropertyType + ")'>מחיקת עדכון מידע</a></span>");
                }
                else if (propType == 0 && allowEdit == 1) {
                    actionscontainer.append("<span class='row_link'><a href='javascript:deleteUnit(" + datarecord.UnitId + "," + datarecord.BuildingId + "," + datarecord.FloorNum + "," + datarecord.PropertyType + ")'>מחיקת יחידה</a></span>");
                }


                var mediaLink = $('<a class="row_link" href="#">תמונות</a>')
               .on("click", function (e) {
                   e.preventDefault();
                   //dialogIframe("_Media?bid=" + datarecord.BuildingId + "&pid=" + datarecord.UnitId + "&pt=u", "900", "520", "מדיה");
                   mediaEditor(datarecord.BuildingId, datarecord.UnitId, "u");
               });
                actionscontainer.append(mediaLink);

                $(actions).append(actionscontainer);

                $(tabsdiv).jqxTabs({ width: '95%', height: 170, rtl: true });
            }
        }
        // create Tree Grid
        $("#jqxgrid").jqxGrid(
        {
            width: '100%',
            autoheight: true,
            rtl: true,
            source: dataAdapter,
            localization: getLocalization('he'),
            virtualmode: true,
            rendergridrows: function (obj) {
                //alert('virtualmode');
                console.log(obj)
                return obj.data;
            },
            pageable: true,
            pagermode: 'simple',
            sortable: false,
            altrows: true,
            rowdetails: true,
            rowdetailstemplate: { rowdetails: "<div style='margin: 10px;'><ul style='margin-right: 30px;'><li class='title'>כללי</li><li>פרטים</li><li>פעולות</li></ul><div class='information'></div><div class='notes'></div><div class='actions'></div></div>", rowdetailsheight: 200 },
            //ready: function () {
            //    $("#jqxgrid").jqxGrid('showrowdetails', 0);
            //    //$("#jqxgrid").jqxGrid('showrowdetails', 1);
            //},
            initrowdetails: initrowdetails,
            columns: [
              { text: 'קוד יחידה', dataField: 'UnitId', width: 100, cellsalign: 'right', align: 'center', cellsrenderer: 
                  function (row, columnfield, value, defaulthtml, columnproperties) {
                    return '<div style="text-align:center"><a href="UnitDef?id=' + value + '&bid=@Model.BuildingId&floor=0&op=0" >הצג</a></div>';
                  }
               },
              { text: 'קומה', dataField: 'FloorNum', width: 120, cellsalign: 'right', align: 'center' },
              { text: 'שטח', dataField: 'UnitSize', width: 120, cellsalign: 'right', align: 'center' },
              { text: 'מחיר', dataField: 'Price', width: 120, cellsalign: 'right', align: 'center' },
              { text: 'סוג עסקה', dataField: 'DealName', width: 120, cellsalign: 'right', align: 'center' },
              { text: 'מטרה', dataField: 'PurposeName', width: 120, cellsalign: 'right', align: 'center' },
              { text: 'מאוכלס', datafield: 'Populate', threestatecheckbox: true, columntype: 'checkbox', width: 70, cellsalign: 'right', align: 'center' },
              { text: 'בעלים', dataField: 'OwnerName', cellsalign: 'right', align: 'center' },
              { text: 'סוכן', dataField: 'UserName', width: 100, cellsalign: 'right', align: 'center' },
              //{ text: 'סלולארי', dataField: 'ContactMobile', width: 150, cellsalign: 'right', align: 'center' },
              { text: 'מועד עדכון', dataField: 'LastUpdate', type: 'date', width: 120, cellsformat: 'd', cellsalign: 'right', align: 'center' }
            ]
        });

    });
   
        function deleteUnit(unitId, BuildingId, FloorNum, PropertyType) {
            app_units.deleteUnit(unitId, BuildingId, FloorNum, PropertyType);
        }

    </script>
}


@section featured {


}

<!--breadcrumb-->
<div class="breadcrumbs">
@Html.ActionLink("Home", "Index", "Home")>
@Html.ActionLink("Main", "Main", "Home")>
<a href="javascript:parent.history.back()">Buildings</a> >
@ViewContext.RouteData.Values["action"].ToString()
</div>

<div class="clear"></div>

<div class="global">
    <div class="container">

        <div class="grid-wrap">
            
             <div style="display: inline; text-align: right; font-size: 18px; direction: rtl;">
                <h3 id="hTitle">רשימת נכסים</h3>
            </div>

            <div id="jqxWidget">
                <div id="jqxgrid" style="position:relative;z-index:1;"></div>
                <div style="margin-top: 30px;">
                    <div id="cellbegineditevent"></div>
                    <div style="margin-top: 10px;" id="cellendeditevent"></div>
                </div>
            </div>
        </div>
    </div>
</div>

<script type="text/javascript">
    activeLayoutMenu("liBuilding");
</script>

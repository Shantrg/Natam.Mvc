@model Natam.Mvc.Models.BuildingFloorsModel
@{
    Layout = "~/Views/Shared/_View.cshtml";
    ViewBag.Title = "Buildings";
}

@section head { 

    @Scripts.Render("~/bundles/jqx")
    @Scripts.Render("~/bundles/jqxgrid")

    <style type="text/css">

        .row_detail {margin: 10px;direction:rtl;}
        .row_link {margin: 10px;direction:rtl;font-size:16px}
        input {direction: rtl;text-align:right;}
        tr.spaceUnder > td {
            padding-bottom: 5px;
        }
        td.labelMid {
            vertical-align: middle;
        }
    </style>
}


@section scripts {

    <script type="text/javascript">
        var allowEdit = 0;

        $(document).ready(function () {
            
            if ('@ViewBag.UserRole' == 9)
                allowEdit = 1;
            else {
                $('#contactSubmit').hide();
                $('#contactReset').hide();
                $('#contactCancel').hide();
                $('#btnRecalc').hide();
                $('#btnFloorWizard').hide();
                
            }

            $('#FloorAddWindow').jqxWindow({
                width: 400,
                height: 160, resizable: false,autoOpen: false,isModal:true,
                cancelButton: $('#cancelFloorButton'),
                initContent: function () {
                    $('#addFloorButton').jqxButton({ width: '80px' });
                    $('#cancelFloorButton').jqxButton({ width: '80px' });
                }
            });


            // First, checks if it isn't implemented yet.
            //if (!String.prototype.format) {
            //    String.prototype.format = function () {
            //        var args = arguments;
            //        return this.replace(/{(\d+)}/g, function (match, number) {
            //            return typeof args[number] != 'undefined'
            //              ? args[number]
            //              : match
            //            ;
            //        });
            //    };
            //}

            //JSON.useDateParser();
            var theme = 'Arctic';

            $("#popupWindow").jqxWindow({ width: 450,height:460, resizable: false, isModal: true, autoOpen: false, cancelButton: $("#Cancel"), modalOpacity: 0.01 });
            $("#contactCancel").jqxButton({ theme: theme });
            $("#contactSubmit").jqxButton({ theme: theme });
            $("#contactReset").jqxButton({ theme: theme });

            var purposeSource =
       {
           dataType: "json",
           async: false,
           dataFields: [
               { name: 'PurposeId' },
               { name: 'PurposeName' }
           ],
           type: 'POST',
           url: '@Url.Action("GetPurposeView", "Building")'
       };
        var purposeAdapter = new $.jqx.dataAdapter(purposeSource);

        $("#Purpose").jqxComboBox(
        {
            rtl: true,
            source: purposeAdapter,
            width: 240,
            autoDropDownHeight: true,
            displayMember: 'PurposeName',
            valueMember: 'PurposeId'
        });

     $("#PurposeFloor").jqxComboBox(
    {
        rtl: true,
        source: purposeAdapter,
        width: 100,
        autoDropDownHeight: true,
        displayMember: 'PurposeName',
        valueMember: 'PurposeId'
    });
       

            // prepare the data
            var source =
            {
                id: 'FloorId',
                datatype: "json",
                 type: 'POST',
                url: '@Url.Action("GetFloorGrid", "Building")',
                //pagenum: 3,
                pagesize: 20
            };
            source.data = {'id':'@Model.BuildingId'};

            var dataAdapter = new $.jqx.dataAdapter(source, {
                loadComplete: function (data) {},
                //loadError: function (xhr, status, error) { alert('error ' + error) }
            });

 
            var getRecord = function (index) {
                return $('#jqxgrid').jqxGrid('getrowdata', index);
            }

            // create Tree Grid
            $("#jqxgrid").jqxGrid(
            {
                width: '100%',
                autoheight: true,
                rtl: true,
                source: dataAdapter,
                localization: getLocalization('he'),
                rendergridrows: function (obj) {
                    return obj.data;
                },
                pageable: true,
                pagermode: 'simple',
                sortable: true,
                altrows: true,
                    
                columns: [
                  {
                      text: 'פעולות', dataField: 'FloorId', width: 180, cellsalign: 'right', align: 'center', filterable: false, cellsrenderer:
                          function (row, columnfield, value, defaulthtml, columnproperties) {
                              var data = $('#jqxgrid').jqxGrid('getrowdata', row);
                                      //return '<div style="text-align:center"><a class="linkEdit" href="#" onclick="investmentEdit(' + data.FloorId + ',' + data.BuildingId + ',' + data.UnitId + '); return false;" >הצג</a></div>';
                              var deleteLink = allowEdit == 1 && data.FloorId ? '<a class="linkEdit" href="#" onclick="deleteFloor(' + data.BuildingId + ',' + data.FloorId + ');return false;">מחיקה</a> | ' : '';
                              var editLink = allowEdit == 1 ? '<a class="linkEdit" href="#" onclick="viewEdit();return false;">עריכה</a> | ' : '';

                              return '<div style="text-align:center">' + editLink +deleteLink+ '<a class="linkEdit" href="UnitGrid?id=' + data.BuildingId + '&floor=' + data.FloorNum + '&op=0">פירוט יחידות</a></div>';
                          }
                  },
                  { text: 'מספר קומה', dataField: 'FloorNum', width: 70, cellsalign: 'right', align: 'center', filtertype: 'textbox', filtercondition: 'contains' },
                  {
                      text: 'תאור', dataField: 'FloorDescription', width: 150, cellsalign: 'right', align: 'center', filterable: false
                  },
                  { text: 'גובה קומה', dataField: 'FloorHeight', width: 70, cellsalign: 'right', align: 'center', filtertype: 'textbox', filtercondition: 'contains' },
                  { text: 'ייעוד', dataField: 'PurposeName', width: 120, cellsalign: 'right', align: 'center', filtertype: 'textbox', filtercondition: 'contains' },
                  { text: 'שטח-קומה', dataField: 'SumFloorArea', width: 90, cellsalign: 'right', align: 'center', filterable: false },
                  { text: 'מאוכלס', datafield: 'SumFloorPopulate', width: 70, cellsalign: 'right', align: 'center', filterable: false },
                  { text: 'פנוי', dataField: 'SumFloorFree', width: 90, cellsalign: 'right', align: 'center', filterable: false },
                  { text: 'לא מוגדר', dataField: 'SumFloorRemain', width: 90, cellsalign: 'right', align: 'center', filterable: false },
                  { text: 'משוער', datafield: 'About', threestatecheckbox: true, columntype: 'checkbox', width: 70, cellsalign: 'right', align: 'center', filterable: false },
                  {text: 'הערות', dataField: 'Memo', cellsalign: 'right', align: 'center', filterable: false}
    
                ]
            });
         });


        function deleteFloor(BuildingId, FloorId) {

            if (confirm("האם למחוק קומה לצמיתות?") == false) {
                return;
            }
            $.ajax({
                url: '@Url.Action("DeleteFloor", "Building")',
                type: 'post',
                dataType: 'json',
                data: {'BuildingId': BuildingId, 'FloorId': FloorId },
                success: function (data) {
                    //alert(data.Message);
                    if (data.Status > 0) {
                        //$("#jqxgrid").jqxGrid('source').dataBind();
                        window.location.reload();
                    }
                },
                error: function (jqXHR, status, error) {
                    alert(error);
                }
            });

        }
    
 
    </script>
}


@section featured {


}
<!--breadcrumb-->
<div class="breadcrumbs">
@Html.ActionLink("Home", "Index", "Home")>
@Html.ActionLink("Main", "Main", "Home")>
<a href="javascript:parent.history.back()">Buildings</a> >
@ViewContext.RouteData.Values["action"].ToString()
</div>


<div class="clear"></div>

<div class="global">
    <div class="container">

        <div class="grid-wrap">
            <div class="box-title">
                <h3>רשימת קומות</h3>
                <a href="BuildingDef?id=@Model.BuildingId" title="הצג בניין"><span>בניין:</span>@Model.BuildingName</a>
            </div>

            <div id="jqxWidget">
                <div id="jqxgrid" style="position:relative;z-index:1;"></div>
                <div style="margin-top: 30px;">
                    <div id="cellbegineditevent"></div>
                    <div style="margin-top: 10px;" id="cellendeditevent"></div>
                    <input id="btnRecalc" class="btn-default btn7" type="button" value="חישוב שטחים" />
                    <input id="btnFloorWizard" class="btn-default btn7" type="button" value="הוספת קומות" />
                </div>
                <div id="popupWindow">
                    <div>
                        <span id="windowTitle"></span>
                    </div>
                    <div id="contactBody">
                        <form class="contactForm" id="contactForm" method="post" action="/Building/UpdateInvestment" target="contact-iframe">
                            <div style="direction: rtl; text-align: right">
                                <input type="hidden" id="FloorId" name="FloorId" value="" />
                                <input type="hidden" id="BuildingId" name="BuildingId" value="" />
                                <input type="hidden" id="UnitId" name="UnitId" value="" />
                                <div class="form-group">
                                    <label class="column">
                                        קומה :
                                    </label>
                                    <input id="FloorNum" name="FloorNum" readonly="readonly" type="number" class="text-mid" />
                                </div>
                                <div id="divCategory" class="form-group">
                                    <label class="column">
                                        ייעוד :
                                    </label>
                                    <div id="Purpose" name="Purpose"></div>
                                </div>
                                <div class="form-group">
                                    <label class="column">
                                        תאור:
                                    </label>
                                    <input type="text" id="FloorDescription" name="FloorDescription" class="text-mid" maxlength="50" />
                                </div>
                                <div class="form-group">
                                    <label class="column">
                                        גובה קומה :
                                    </label>
                                    <input id="FloorHeight" name="FloorHeight" type="number" class="text-mid" />
                                </div>
                                <div class="form-group">
                                    <label class="column">
                                        שטח- מ"ר" :
                                    </label>
                                    <input id="SumFloorArea" name="SumFloorArea" type="number" class="text-mid" />
                                </div>
                                <div class="form-group">
                                    <label class="column">
                                        מאוכלס :
                                    </label>
                                    <input id="SumFloorPopulate" name="SumFloorPopulate" type="number" class="text-mid" readonly="readonly" />
                                </div>
                                <div class="form-group">
                                    <label class="column">
                                        פנוי :
                                    </label>
                                    <input id="SumFloorFree" name="SumFloorFree" type="number" class="text-mid" readonly="readonly" />
                                </div>
                                <div class="form-group">
                                    <label class="column">
                                        הערות:
                                    </label>
                                    <textarea id="Memo" name="Memo" rows="3" cols="60"></textarea>
                                </div>
                                <div id="divAll" class="form-group">
                                    <label class="column">
                                        משוער:
                                    </label>
                                    <input id="About" name="About" type="checkbox" />
                                </div>
                                <div style="height: 5px"></div>
                                <div>
                                    <input id="contactSubmit" class="btn-default btn7" type="button" value="עדכון" />
                                    <input id="contactReset" class="btn-default btn7" type="button" value="ניקוי" />
                                    <input id="contactCancel" class="btn-default btn7" type="button" value="ביטול" />
                                </div>
                            </div>
                        </form>
                    </div>
                </div>
                <div id="FloorAddWindow">
                    <div id="customWindowHeader">
                        <span id="captureContainer" style="float: left">הוספת קומה</span>
                    </div>
                    <div id="customWindowContent" style="overflow: hidden">
                        <div style="margin: 10px; direction: rtl;float: right">
                            <table>
                                <tr class="spaceUnder">
                                    <td class="labelMid">מספר קומות:</td>
                                    <td></td>
                                    <td><input type="number" style="width: 100px; border: 1px solid #aaa" id="FloorNoInput" value="1" /></td>
                                </tr>
                                <tr class="spaceUnder">
                                    <td class="labelMid">שטח קומה:</td>
                                    <td></td>
                                    <td><input type="number" style="width: 100px; border: 1px solid #aaa" id="FloorSizeInput" /></td>
                                </tr>
                                <tr class="spaceUnder">
                                    <td class="labelMid">סוג הנכס:</td>
                                    <td></td>
                                    <td><div id="PurposeFloor" name="PurposeFloor"></div></td>
                                </tr>
                            </table>
                        </div>
                        <div style="float: left">
                            <input type="button" value="אישור" style="margin-bottom: 5px;" id="addFloorButton" /><br />
                            <input type="button" value="ביטול" id="cancelFloorButton" />
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

    <script type="text/javascript">

        // initialize the popup window and buttons.


        function viewEdit() {
            var rowindex = $("#jqxgrid").jqxGrid('getselectedrowindex');
            //var offset = $("#jqxgrid").offset();
            //$("#popupWindow").jqxWindow({ position: { x: parseInt(offset.left) + 60, y: parseInt(offset.top) + 60 } });

            // get the clicked row's data and initialize the input fields.
            var dataRecord = $("#jqxgrid").jqxGrid('getrowdata', rowindex);
            app_jqxcombos.selectComboBoxValue("Purpose", dataRecord.Purpose);
            $("#FloorId").val(dataRecord.FloorId);
            $("#FloorNum").val(dataRecord.FloorNum);
            $("#BuildingId").val(dataRecord.BuildingId);
            $("#FloorDescription").val(dataRecord.FloorDescription);
            $("#FloorHeight").val(dataRecord.FloorHeight);
            //$("#AreaType").val(dataRecord.AreaType);
            // $("#Purpose").val(dataRecord.Purpose);
            $("#Measure").val(dataRecord.Measure);
            $("#SumFloorArea").val(dataRecord.SumFloorArea);
            $("#SumFloorPopulate").val(dataRecord.SumFloorPopulate);
            $("#SumFloorFree").val(dataRecord.SumFloorFree);
            $("#SumFloorRemain").val(dataRecord.SumFloorRemain);
            $("#About").attr("checked", dataRecord.About);
            $("#Memo").val(dataRecord.Memo);

            if (dataRecord.FloorId > 0) {
                var title = "הגדרת קומה";
                $("#windowTitle").html(title);
                $("#divAll").hide();
                // show the popup window.
                $("#popupWindow").jqxWindow('show');
            }
            else {
                alert("הגדרת קומה אינה תקינה");
            }
        };

        //contactount dialog
        $('#contactForm').jqxValidator({
            rtl: true,
            hintType: 'label',
            animationDuration: 0,
            rules: [
               //{
               //    input: '#FloorHeight', message: 'חובה לציין גובה!', action: 'keyup, blur', rule: function () {
               //        var value = $("#FloorHeight").val();
               //        return value > 0;
               //    }
               //},
              {
                  input: '#SumFloorArea', message: 'חובה לציין שטח קומה!', action: 'keyup, blur', rule: function () {
                      var value = $("#SumFloorArea").val();
                      return value > 0;
                  }
              }
            ]
        });

        $('#contactSubmit').on('click', function (e) {

            app_rout.isAllowEdit(allowEdit);
            var validationResult = function (isValid) {
                if (isValid && allowEdit == 1) {
                    $.ajax({
                        url: '@Url.Action("UpdateFloor", "Building")',
                        type: 'post',
                        dataType: 'json',
                        data: $('#contactForm').serialize(),
                        success: function (data) {

                            if (data.Status >= 0) {
                                $('#popupWindow').jqxWindow('close');
                                $('#jqxgrid').jqxGrid('source').dataBind();
                            }
                            else
                                alert(data.Message);
                        },
                        error: function (jqXHR, status, error) {
                            alert(error);
                        }
                    });
                }
                else {
                    e.preventDefault(); // t
                }
            }
            $('#contactForm').jqxValidator('validate', validationResult);

        });

        $('#contactCancel').on('click', function (e) {
            $('#popupWindow').jqxWindow('close');
        });

        $('#contactReset').on('click', function (e) {
            $('#contactForm')[0].reset();
            $('#contactForm').jqxValidator('hide');
        });
        $('#btnRecalc').on('click', function (e) {
            if (confirm("פעולה זו תבצע חישוב מחדש של השטחים בבניין הנוכחי,האם להמשיך?") == false)
                return;
            var buildingId = '@Model.BuildingId';
            $.ajax({
                url: '@Url.Action("RecalcFloor", "Building")',
                type: 'post',
                dataType: 'json',
                data: { 'BuildingId': buildingId },
                success: function (data) {
                    //if (data.Status >= 0) {
                    $('#jqxgrid').jqxGrid('source').dataBind();
                    //}
                },
                error: function (jqXHR, status, error) {
                    alert(error);
                }
            });

        });
        $('#btnFloorWizard').on('click', function (e) {

            $('#FloorAddWindow').jqxWindow('open');

        });

        $('#addFloorButton').on('click', function (e) {

            var floorNo = parseInt($("#FloorNoInput").val());
            var floorSize = parseFloat($("#FloorSizeInput").val());
            var floorDown = '@Model.FloorNoDown';
            var floorUp = '@Model.FloorNoUp';
            var floorPurpose = $("#PurposeFloor").val();

            //if ((floorNo > 0 && floorNo <= floorUp) || floorNo <= 0 && floorNo > floorDown) {
            //    alert("מספר קומה קיים במערכת נא לבחור מספר קומה אחר");
            //    return;
            //}

            //if ((floorNo > 0 && Math.abs(floorUp - floorNo) > 1) || floorNo <= 0 && Math.abs(floorDown - floorNo) > 1) {
            //    alert("מספר קומה אינו בסדר עוקב, נא לבחור מספר קומה אחר");
            //    return;
            //}
            if (floorNo <= 0) {
                alert("מספר קומות אינו תקין");
                return;
            }
            if (floorSize <= 0) {
                alert("שטח קומה אינו תקין");
                return;
            }
            if (floorNo > 1) {
                if (confirm("האם להוסיף " + floorNo + " קומות ") == false)
                    return;
            }

            var buildingId = '@Model.BuildingId';
            $.ajax({
                url: '@Url.Action("FloorAdd", "Building")',
                type: 'post',
                dataType: 'json',
                data: { 'BuildingId': buildingId, 'FloorNo': floorNo, 'FloorSize': floorSize, 'Purpose': floorPurpose },
                success: function (data) {
                    //if (data.Status >= 0) {
                    $('#jqxgrid').jqxGrid('source').dataBind();
                    //$('#FloorAddWindow').jqxWindow('close');
                    window.location.reload();
                    //}
                },
                error: function (jqXHR, status, error) {
                    alert(error);
                }
            });

        });

    </script>
    <script type="text/javascript">
        app_menu.activeLayoutMenu("liBuilding");
    </script>

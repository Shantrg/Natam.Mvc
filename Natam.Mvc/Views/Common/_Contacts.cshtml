@{

    ViewBag.Title = "Buildings";
    Layout = "~/Views/Shared/_ViewIframe.cshtml";
    int id = Nistec.Types.ToInt(Request["id"]);
    int role = Nistec.Types.ToInt(Request["role"]);
    string uk = Request["uk"];
}

@section head {

    @Scripts.Render("~/bundles/jqx")
    @Scripts.Render("~/bundles/jqxgrid")

    <link rel="stylesheet" href="~/Scripts/app/app-form.css" type="text/css" />
 
}

@section scripts {
    <script type="text/javascript">

        var NSaccountcontacts = {};
        var isMobile = app.IsMobile();
        $(document).ready(function () {

            var id = '@id';
            var role = '@role';
            var uk = '@uk';

                //contacts
            var nastedsource = {
                datafields: [
                      { name: 'ContactId', type: 'number' },
                      { name: 'AccountId', type: 'number' },
                      { name: 'ContactName', type: 'string' },
                      { name: 'Title', type: 'string' },
                      { name: 'Email', type: 'string' },
                      { name: 'Phone1', type: 'string' },
                      { name: 'Mobile', type: 'string' }
                ],
                datatype: "json",
                id: 'ContactId',
                type: 'POST',
                url: '@Url.Action("GetContactsView", "Crm")',
                data: { 'parentId': id, 'role': role, 'uk': uk }
            }

                var nastedAdapter = new $.jqx.dataAdapter(nastedsource);
                $("#jqxgrid").jqxGrid({
                    source: nastedAdapter, width: '90%', height: 180,
                    autoheight: true,
                    scrollmode: 'logical',
                    rtl: true,
                    columns: [
                      { text: 'שם איש קשר', datafield: 'ContactName', width: 120, cellsalign: 'right', align: 'center' },
                      {
                          text: 'טלפון נייד', datafield: 'Mobile', width: 100, align: 'center', cellsrenderer: function (row, datafield, value) {
                              return isMobile ? '<a style="float:right;"  href="tel:' + value + '">' + value + '</a>' : '<span style="float:right">' + value + '</span>';
                          }
                      },
                      {
                          text: 'דואל', datafield: 'Email', width: 120, align: 'center', cellsrenderer: function (row, datafield, value) {
                              return '<a href="mailto:' + value + '">' + value + '</a>';
                          }
                      },
                      { text: 'תפקיד', datafield: 'Title', width: 100, cellsalign: 'right', align: 'center', hidden: isMobile },
                      {
                        text: 'פעולות', dataField: 'ContactId', width: 90, cellsalign: 'right', align: 'center',
                            cellsrenderer: function (row, columnfield, value, defaulthtml, columnproperties) {
                                return '<div style="text-align:center;direction:rtl;margin:5px;"><a href="#" onclick="accountContacts_contactEdit(' + value + ');">עריכה</a> | <a href="#" onclick="accountContacts_contactDelete(' + value + ');">הסרה</a></div>'
                            }
                       }
                ]
                });

                $('#btnAddItem').click(function () {
                    NSaccountcontacts.contactdialog = app_contacts.contactEdit(0, id, role, uk);// "d");
                });
                $('#btnRefresh').click(function () {
                    nastedAdapter.dataBind();
                });
        });

        function triggerContactComplete(accid) {
            try {
                var adapter = $("#jqxgrid").jqxGrid('source');
                adapter.dataBind();
                app_dialog.dialogClose(NSaccountcontacts.contactdialog);
            }
            catch (e) {

            }
        }
        function accountContacts_contactDelete(id) {
            app_contacts.contactDelete(id, false);
            $("#jqxgrid").jqxGrid('source').dataBind();
        }

        function accountContacts_contactEdit(id) {
            NSaccountcontacts.contactdialog = app_contacts.contactEdit(id, 0, 0);
        }

     </script>
}

<div style="margin: 5px;">

    <div id="jqxWidget" style="margin: 0 auto; display: block; direction: rtl">
        <div id="accWindow">
            <div id="accHeader">
            </div>
            <div id="accBody">
               <input value="הוספת איש קשר" id="btnAddItem" type="button" />
               <input value="רענון" id="btnRefresh" type="button" />
               <div id="jqxgrid" style="position:relative;z-index:1;"></div>
            </div>
        </div>

    </div>
</div>
<!--end of content-wrapper-->
